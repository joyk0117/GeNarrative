{% extends "base.html" %}

{% block title %}Text Generation Server - GeNarrative{% endblock %}

{% block content %}
<div class="container">
    <div class="server-header">
        <h2>üìù Text Generation Server</h2>
        <p class="server-description">Monitor Ollama status, manage models, and run quick prompt tests.</p>
    </div>

    <div class="server-content">
        <div class="server-sections">
            <section class="server-section">
                <h3>üîß Server Status</h3>
                <div class="status-grid">
                    <div class="status-card" id="ollama-status">
                        <div class="status-header">
                            <span class="status-indicator offline" id="status-indicator"></span>
                            <span class="status-text" id="status-text">Checking...</span>
                            <button class="btn btn-refresh" id="refresh-status">Refresh</button>
                        </div>
                        <dl class="status-details">
                            <div>
                                <dt>Internal URI</dt>
                                <dd><code id="uri-internal">-</code></dd>
                            </div>
                            <div>
                                <dt>External URI</dt>
                                <dd><a id="uri-external-link" href="#" target="_blank"><code id="uri-external">-</code></a></dd>
                            </div>
                            <div>
                                <dt>GPU Available</dt>
                                <dd><span id="gpu-text">Unknown</span></dd>
                            </div>
                        </dl>
                    </div>
                    <div class="status-card" id="model-status">
                        <div class="status-header">
                            <span class="status-indicator offline" id="model-indicator"></span>
                            <span class="status-text" id="model-text">Not loaded</span>
                        </div>
                        <div class="model-row">
                            <label for="model-select" class="label">Installed Models</label>
                            <select id="model-select" class="model-input">
                                <option value="">-- Select installed model --</option>
                            </select>
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-secondary" id="load-model">Load</button>
                            <button class="btn btn-secondary" id="unload-model">Unload</button>
                        </div>
                        <p class="small" id="load-status"></p>
                    </div>
                </div>
            </section>

            <section class="server-section">
                <h3>üß™ Test Text Generation</h3>
                <div class="gen-grid">
                    <div class="prompt-col">
                        <label for="gen-prompt" class="label">Prompt</label>
                        <textarea id="gen-prompt" class="prompt-input" rows="4" placeholder="Êó•Êú¨„ÅÆ‰ºùÁµ±ÊñáÂåñ„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶"></textarea>
                    </div>
                    <div class="controls">
                        <div class="control-row">
                            <label for="gen-max-tokens">Max tokens</label>
                            <input type="number" id="gen-max-tokens" value="256" min="16" max="2048" />
                        </div>
                        <div class="control-row">
                            <label for="gen-temp">Temperature</label>
                            <input type="number" id="gen-temp" value="0.7" step="0.1" min="0" max="2" />
                        </div>
                        <button class="btn btn-primary" id="run-generate">Generate</button>
                    </div>
                </div>
                <div class="log-container">
                    <div class="log-content" id="gen-response"></div>
                </div>
            </section>
        </div>
    </div>
</div>

<style>
.server-header {
    text-align: center;
    margin-bottom: 2rem;
}

.server-header h2 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.server-description {
    color: #666;
    font-size: 1.05rem;
}

.server-content {
    max-width: 1000px;
    margin: 0 auto;
}

.server-sections {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.server-section {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.server-section h3 {
    margin-bottom: 1rem;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.4rem;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
}

.status-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    background: #f9f9f9;
}

.status-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.status-indicator {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #dc3545;
}

.status-indicator.online { background: #28a745; }
.status-indicator.offline { background: #dc3545; }

.status-text {
    font-weight: bold;
    flex: 1;
}

.status-details {
    margin: 0;
    padding: 0;
}

.status-details > div {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-family: 'Menlo', 'Monaco', monospace;
}

.status-details dt {
    font-weight: 600;
}

.status-details dd {
    margin: 0;
}

.btn {
    display: inline-block;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
}

.btn-refresh { background: #17a2b8; color: #fff; }
.btn-primary { background: #007bff; color: #fff; }
.btn-secondary { background: #6c757d; color: #fff; }

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.model-row { margin-bottom: 1rem; }
.model-input {
    width: 100%;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #ced4da;
}

.btn-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.small {
    margin-top: 10px;
    font-size: 0.85rem;
    color: #555;
}

.gen-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
}

.prompt-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-family: inherit;
}

.controls {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.control-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}

.control-row input {
    width: 120px;
    padding: 6px 10px;
}

.label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.log-container {
    margin-top: 1rem;
    background: #1f1f1f;
    border-radius: 6px;
    padding: 1rem;
    color: #f5f5f5;
}

.log-content {
    font-family: 'Consolas', monospace;
    min-height: 120px;
    white-space: pre-wrap;
}

.log-entry {
    margin: 0;
    font-size: 0.9rem;
}

.log-entry.error {
    color: #ff6b6b;
}

.json-response {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
    font-size: 0.85rem;
}

@media (max-width: 768px) {
    .control-row {
        flex-direction: column;
        align-items: flex-start;
    }

    .control-row input {
        width: 100%;
    }
}
</style>

<script>
function updateHealthStatus() {
    fetch('/api/servers/text/status')
        .then(response => response.json())
        .then(data => {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const modelIndicator = document.getElementById('model-indicator');
            const modelText = document.getElementById('model-text');
            const gpuText = document.getElementById('gpu-text');
            const uriInternal = document.getElementById('uri-internal');
            const uriExternal = document.getElementById('uri-external');
            const uriExternalLink = document.getElementById('uri-external-link');
            const modelSelect = document.getElementById('model-select');

            if (data.online) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'Online';

                const serverData = data.health || {};
                uriInternal.textContent = data.server_uri_internal || '-';
                uriExternal.textContent = data.server_uri_external || '-';
                uriExternalLink.href = data.server_uri_external || '#';

                if (data.model_loaded || serverData.model_loaded) {
                    modelIndicator.className = 'status-indicator online';
                    modelText.textContent = data.loaded_model || serverData.loaded_model || 'Loaded';
                } else {
                    modelIndicator.className = 'status-indicator offline';
                    modelText.textContent = 'Not loaded';
                }

                try {
                    const installed = (data.model_status && data.model_status.installed_models) || [];
                    const previous = modelSelect.value;
                    modelSelect.innerHTML = '<option value="">-- Select installed model --</option>' +
                        installed.map(m => `<option value="${m}">${m}</option>`).join('');
                    if (installed.includes(previous)) {
                        modelSelect.value = previous;
                    } else if (installed.length > 0) {
                        modelSelect.value = installed[0];
                    }
                } catch (_) {
                    // no-op
                }

                gpuText.textContent = serverData.gpu_available ? 'Yes' : 'No';
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = data.error ? 'Error' : 'Offline';
                modelIndicator.className = 'status-indicator offline';
                modelText.textContent = 'Unknown';
                gpuText.textContent = 'Unknown';
                uriInternal.textContent = '-';
                uriExternal.textContent = '-';
                uriExternalLink.href = '#';
                modelSelect.innerHTML = '<option value="">-- Select installed model --</option>';
            }
        })
        .catch(error => {
            console.error('Error fetching health status:', error);
            document.getElementById('status-indicator').className = 'status-indicator offline';
            document.getElementById('status-text').textContent = 'Connection Error';
        });
}

function handleLoadModel() {
    const modelId = (document.getElementById('model-select').value || 'gemma3:4b-it-qat').trim();
    const loadButton = document.getElementById('load-model');
    const unloadButton = document.getElementById('unload-model');
    const loadStatus = document.getElementById('load-status');

    loadButton.textContent = 'Loading...';
    loadButton.disabled = true;
    unloadButton.disabled = true;
    loadStatus.textContent = '';

    fetch('/api/servers/text/model/load', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model_id: modelId })
    })
        .then(resp => resp.json().then(data => ({ ok: resp.ok, status: resp.status, data })))
        .then(result => {
            if (!result.ok || result.data.success === false) {
                throw new Error(result.data.error || `HTTP ${result.status}`);
            }
            loadStatus.textContent = 'Model loaded successfully';
            updateHealthStatus();
        })
        .catch(err => {
            alert('Load failed: ' + err.message);
            loadStatus.textContent = 'Error: ' + err.message;
        })
        .finally(() => {
            loadButton.textContent = 'Load';
            loadButton.disabled = false;
            unloadButton.disabled = false;
        });
}

function handleUnloadModel() {
    const btn = document.getElementById('unload-model');
    btn.disabled = true;
    fetch('/api/servers/text/model/unload', { method: 'POST' })
        .then(resp => resp.json().then(data => ({ ok: resp.ok, status: resp.status, data })))
        .then(result => {
            if (!result.ok || result.data.success === false) {
                throw new Error(result.data.error || `HTTP ${result.status}`);
            }
            setTimeout(updateHealthStatus, 1000);
            setTimeout(updateHealthStatus, 3000);
            setTimeout(updateHealthStatus, 6000);
        })
        .catch(err => {
            alert('Unload failed: ' + err.message);
        })
        .finally(() => {
            btn.disabled = false;
        });
}

function handleGenerate() {
    const prompt = (document.getElementById('gen-prompt').value || '').trim();
    const maxTokens = parseInt(document.getElementById('gen-max-tokens').value || '256', 10);
    const temp = parseFloat(document.getElementById('gen-temp').value || '0.7');
    const out = document.getElementById('gen-response');
    out.innerHTML = '';

    if (!prompt) {
        alert('Prompt is required');
        return;
    }

    fetch('/api/servers/text/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, max_tokens: maxTokens, temperature: temp })
    })
        .then(resp => resp.json().then(data => ({ ok: resp.ok, status: resp.status, data })))
        .then(result => {
            if (!result.ok || result.data.success === false) {
                throw new Error(result.data.error || `HTTP ${result.status}`);
            }
            const pretty = JSON.stringify(result.data, null, 2);
            out.innerHTML = `<pre class="json-response">${pretty}</pre>`;
        })
        .catch(err => {
            out.innerHTML = `<p class="log-entry error">${err.message}</p>`;
        });
}

document.addEventListener('DOMContentLoaded', () => {
    updateHealthStatus();
    document.getElementById('refresh-status').addEventListener('click', updateHealthStatus);
    document.getElementById('load-model').addEventListener('click', handleLoadModel);
    document.getElementById('unload-model').addEventListener('click', handleUnloadModel);
    document.getElementById('run-generate').addEventListener('click', handleGenerate);
    setInterval(updateHealthStatus, 30000);
});
</script>
{% endblock %}
