{% extends "base.html" %}

{% block title %}Scene {{ scene.id }} - Project {{ scene.project_id }} - GeNarrative UI{% endblock %}

{% block content %}
<div class="container">
    <div class="breadcrumb">
        <a href="/projects">Projects</a> / 
        <a href="/projects/{{ scene.project_id }}">{{ scene.project_id }}</a> / 
        <span>{{ scene.id }}</span>
    </div>
    
    <h2>Scene: {{ scene.id }}</h2>
    
    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ÔºöÁîªÂÉèÔºàÂ∑¶Ôºâ„Å®„ÉÜ„Ç≠„Çπ„Éà+Èü≥Ê•ΩÔºàÂè≥Ôºâ -->
    <div class="main-content">
        <!-- Â∑¶ÂÅ¥ÔºöÁîªÂÉè„Çª„ÇØ„Ç∑„Éß„É≥ -->
        {% if scene.image_files %}
        <div class="left-panel">
            <section class="scene-section image-section">
                <h3>Image</h3>
                <div class="section-controls">
                    <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="uploadImage(this)">
                    <button class="btn btn-upload" onclick="document.getElementById('image-upload').click()">
                        üìÅ Upload Image
                    </button>
                    <button class="btn btn-download" onclick="downloadImage()">
                        üíæ Download Image
                    </button>
                </div>
                <div class="image-gallery">
                    {% for image_file in scene.image_files %}
                    <div class="image-container">
                        <h4>{{ image_file }}</h4>
                        <img src="/projects/{{ scene.project_id }}/scenes/{{ scene.id }}/file/{{ image_file }}" alt="{{ image_file }}" class="scene-image">
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
        {% else %}
        <div class="left-panel">
            <section class="scene-section image-section">
                <h3>Image</h3>
                <div class="section-controls">
                    <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="uploadImage(this)">
                    <button class="btn btn-upload" onclick="document.getElementById('image-upload').click()">
                        üìÅ Upload Image
                    </button>
                </div>
                <div class="no-content">
                    No image available. You can upload an image using the button above.
                </div>
            </section>
        </div>
        {% endif %}

        <!-- Âè≥ÂÅ¥ÔºöText & Speech „Å® Music -->
        <div class="right-panel">
            <!-- „ÉÜ„Ç≠„Çπ„Éà„Å®TTS -->
            <section class="scene-section text-section">
                <h3>Text & Speech</h3>
                {% if scene.text_files %}
                    {% for text_file in scene.text_files %}
                    <div class="text-container">
                        <h4>{{ text_file }}</h4>
                        <div class="text-content">
                            <iframe src="/projects/{{ scene.project_id }}/scenes/{{ scene.id }}/file/{{ text_file }}" frameborder="0"></iframe>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-content">No text content available</div>
                {% endif %}

                <!-- TTSÈü≥Â£∞ -->
                {% if scene.tts_files %}
                    <div class="tts-container">
                        <h4>Text-to-Speech Audio</h4>
                        {% for tts_file in scene.tts_files %}
                        <div class="audio-player">
                            <audio controls>
                                <source src="/projects/{{ scene.project_id }}/scenes/{{ scene.id }}/file/{{ tts_file }}" type="audio/wav">
                                Your browser does not support the audio element.
                            </audio>
                            <a href="/projects/{{ scene.project_id }}/scenes/{{ scene.id }}/file/{{ tts_file }}" download="{{ tts_file }}" class="btn btn-download">
                                üíæ Download
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </section>

            <!-- Music -->
            <section class="scene-section music-section">
                <h3>Music</h3>
                {% if scene.music_files %}
                    {% for music_file in scene.music_files %}
                    <div class="music-container">
                        <h4>{{ music_file }}</h4>
                        <div class="audio-player">
                            <audio controls>
                                <source src="/projects/{{ scene.project_id }}/scenes/{{ scene.id }}/file/{{ music_file }}" type="audio/wav">
                                Your browser does not support the audio element.
                            </audio>
                            <a href="/projects/{{ scene.project_id }}/scenes/{{ scene.id }}/file/{{ music_file }}" download="{{ music_file }}" class="btn btn-download">
                                üíæ Download
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-content">No music available</div>
                {% endif %}
            </section>
        </div>
    </div>

    <!-- SIS Section -->
    <section class="scene-section sis-section">
        <h3>Scene Information Structure (SIS)</h3>
        <div class="section-controls">
            <button class="btn btn-edit" onclick="toggleSISEdit()">‚úèÔ∏è Edit</button>
            <button class="btn btn-save" id="btn-sis-save" onclick="saveSIS()" style="display:none;">üíæ Save</button>
            <button class="btn btn-cancel" id="btn-sis-cancel" onclick="cancelSISEdit()" style="display:none;">‚ùå Cancel</button>
            <button class="btn btn-download" onclick="downloadSIS()">üíæ Download JSON</button>
        </div>
        {% if scene.sis_files %}
            {% for sis_file in scene.sis_files %}
            <div class="sis-container">
                <h4>{{ sis_file }}</h4>
                <textarea id="sis-editor" class="sis-editor" readonly>Loading...</textarea>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-content">No SIS data available</div>
        {% endif %}
    </section>

    <!-- Prompt Files Section -->
    {% if scene.prompt_files %}
    <section class="scene-section prompt-section">
        <h3>Prompt Files</h3>
        <div class="prompt-files-grid">
            {% for prompt_file in scene.prompt_files %}
            <div class="prompt-file-card">
                <h4>{{ prompt_file }}</h4>
                <div class="prompt-content">
                    <iframe src="/projects/{{ scene.project_id }}/scenes/{{ scene.id }}/file/{{ prompt_file }}" frameborder="0"></iframe>
                </div>
                <a href="/projects/{{ scene.project_id }}/scenes/{{ scene.id }}/file/{{ prompt_file }}" download="{{ prompt_file }}" class="btn btn-download">
                    üíæ Download
                </a>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

<style>
.breadcrumb {
    margin-bottom: 20px;
    font-size: 14px;
    color: #666;
}

.breadcrumb a {
    color: #007bff;
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.left-panel, .right-panel {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.scene-section {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.scene-section h3 {
    margin: 0 0 16px 0;
    color: #333;
    font-size: 20px;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.section-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.btn-upload {
    background-color: #28a745;
    color: white;
}

.btn-upload:hover {
    background-color: #218838;
}

.btn-download {
    background-color: #17a2b8;
    color: white;
}

.btn-download:hover {
    background-color: #138496;
}

.btn-edit {
    background-color: #ffc107;
    color: #333;
}

.btn-edit:hover {
    background-color: #e0a800;
}

.btn-save {
    background-color: #28a745;
    color: white;
}

.btn-save:hover {
    background-color: #218838;
}

.btn-cancel {
    background-color: #6c757d;
    color: white;
}

.btn-cancel:hover {
    background-color: #5a6268;
}

.image-gallery, .text-container, .music-container, .tts-container {
    margin-top: 16px;
}

.scene-image {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.text-content iframe {
    width: 100%;
    height: 300px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.audio-player {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.audio-player audio {
    flex: 1;
}

.no-content {
    padding: 20px;
    text-align: center;
    color: #6c757d;
    background: #f8f9fa;
    border-radius: 6px;
    border: 2px dashed #dee2e6;
}

.sis-editor {
    width: 100%;
    min-height: 400px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    background: #f8f9fa;
}

.prompt-files-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 16px;
}

.prompt-file-card {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 16px;
    background: #f8f9fa;
}

.prompt-file-card h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #495057;
}

.prompt-content iframe {
    width: 100%;
    height: 150px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
}

@media (max-width: 1024px) {
    .main-content {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
const sceneId = "{{ scene.id }}";
const projectId = "{{ scene.project_id }}";
let originalSISData = null;

// Load SIS data on page load
document.addEventListener('DOMContentLoaded', async function() {
    const sisEditor = document.getElementById('sis-editor');
    if (sisEditor) {
        try {
            const sisFiles = {{ scene.sis_files | tojson }};
            if (sisFiles && sisFiles.length > 0) {
                const response = await fetch(`/projects/${projectId}/scenes/${sceneId}/file/${sisFiles[0]}`);
                const sisData = await response.json();
                originalSISData = sisData;
                sisEditor.value = JSON.stringify(sisData, null, 2);
            }
        } catch (error) {
            console.error('Failed to load SIS data:', error);
            sisEditor.value = 'Failed to load SIS data';
        }
    }
});

function toggleSISEdit() {
    const editor = document.getElementById('sis-editor');
    const saveBtn = document.getElementById('btn-sis-save');
    const cancelBtn = document.getElementById('btn-sis-cancel');
    
    editor.readOnly = false;
    editor.style.background = 'white';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
}

function cancelSISEdit() {
    const editor = document.getElementById('sis-editor');
    const saveBtn = document.getElementById('btn-sis-save');
    const cancelBtn = document.getElementById('btn-sis-cancel');
    
    editor.value = JSON.stringify(originalSISData, null, 2);
    editor.readOnly = true;
    editor.style.background = '#f8f9fa';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
}

async function saveSIS() {
    const editor = document.getElementById('sis-editor');
    
    try {
        const sisData = JSON.parse(editor.value);
        
        const response = await fetch(`/projects/${projectId}/scenes/${sceneId}/save_sis`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(sisData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            originalSISData = sisData;
            editor.readOnly = true;
            editor.style.background = '#f8f9fa';
            document.getElementById('btn-sis-save').style.display = 'none';
            document.getElementById('btn-sis-cancel').style.display = 'none';
            alert('SIS data saved successfully!');
        } else {
            alert(`Failed to save SIS: ${result.error}`);
        }
    } catch (error) {
        alert(`Error saving SIS: ${error.message}`);
    }
}

function downloadSIS() {
    const editor = document.getElementById('sis-editor');
    const sisData = editor.value;
    
    const blob = new Blob([sisData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sis_structure_${sceneId}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

async function uploadImage(input) {
    if (!input.files || !input.files[0]) return;
    
    const formData = new FormData();
    formData.append('image', input.files[0]);
    
    try {
        const response = await fetch(`/projects/${projectId}/scenes/${sceneId}/upload_image`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Image uploaded successfully!');
            location.reload();
        } else {
            alert(`Failed to upload image: ${result.error}`);
        }
    } catch (error) {
        alert(`Error uploading image: ${error.message}`);
    }
}

function downloadImage() {
    const imageFiles = {{ scene.image_files | tojson }};
    if (imageFiles && imageFiles.length > 0) {
        window.location.href = `/projects/${projectId}/scenes/${sceneId}/file/${imageFiles[0]}`;
    } else {
        alert('No image available to download');
    }
}
</script>
{% endblock %}
